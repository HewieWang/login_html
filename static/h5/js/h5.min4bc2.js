function plusReady(){plus.push.addEventListener("click",function(e){console.log("You clicked: "+e.title),console.log("You clicked: "+e.content);var t=e.payload;console.log(JSON.stringify(e)),t&&(typeof t=="string"&&(t=JSON.parse(t)),typeof t=="object"&&t.path&&(t.path.indexOf("https://demo.popoim.cn/")===0&&(t.path=t.path.substr(1)),console.log(popim.data.baseUri+t.path),page(popim.data.baseUri+t.path)))},!1),plus.push.addEventListener("receive",function(e){console.log("recieve title: "+e.title),console.log("recieve content: "+e.content)},!1)}(function(){function a(e){if(!popim.check(e))return;var t=e.params.uid;u.uid=t,u.gid=e.params.gid||0;var n=popim.getFriendFromLocal(t);n&&(u.avatar=n.avatar,u.nickname=n.name,u.remarkname="",u.username="　",u.isFriend=!0,u.sign=" "),popim.ajax({url:popim.data.api.userDetail,type:"get",data:{uid:t},success:function(e){e.code==0&&(u.avatar=e.data.avatar,u.nickname=e.data.nickname,u.remarkname=e.data.remark,u.username=e.data.username,u.isFriend=e.data.is_friend,u.sign=e.data.sign,u.accountState=e.data.account_state)}}),popim.show("user_detail")}popim={data:{chatting:{},friend:[],group:[],mine:[],setting:[],show:"none",networkState:"",dataLoading:!1,baseUri:"/im/h5/",api:{baseInfo:"/h5/pop/get",deleteChat:"/h5/pop/delchat",userJoin:"/h5/login/join",userDetail:"/h5/user/detail",userUpdate:"/h5/user/update",getUserByName:"/h5/user/getbyname",loginCheck:"/h5/login/check",loginCaptcha:"/h5/login/logincaptcha",getSetting:"/h5/login/getsetting",logout:"/h5/login/logout",joinCaptcha:"/h5/login/joincaptcha",messageSend:"/h5/message/send",messageRevoke:"/h5/message/revoke",messageGet:"/h5/message/get",messageUnreadCount:"/h5/message/unreadcount",updateLastReadTime:"/h5/message/updateLastReadTime",uploadImage:"/h5/upload/img",uploadFile:"/h5/upload/file",uploadAvatar:"/h5/upload/avatar",friendList:"/h5/friend/getlist",friendApply:"/h5/friend/apply",friendApplyList:"/h5/friend/applylist",friendApplyDetail:"/h5/friend/applydetail",friendApplyCount:"/h5/friend/applycount",friendAgree:"/h5/friend/agree",friendRefuse:"/h5/friend/refuse",friendDelete:"/h5/friend/delete",friendRemark:"/h5/friend/remark",friendUpdate:"/h5/friend/update",groupCreate:"/h5/group/create",groupDetail:"/h5/group/detail",groupForbiddenUser:"/h5/group/forbiddenuser",groupForbiddenAll:"/h5/group/forbiddenall",groupLeave:"/h5/group/leave",groupDelete:"/h5/group/delete",groupMemberAdd:"/h5/group/memberadd",groupMemberDelete:"/h5/group/memberdel",groupMembers:"/h5/group/members",groupRemark:"/h5/group/remark",groupUpdate:"/h5/group/update",groupMemberUpdate:"/h5/group/memberupdate",authEndpoint:"/h5/push/auth"}},isback:!1,connecter:null,show:function(e){if(e!="home"&&e!="login"&&e!="join"&&!popim.data.mine.uid){var t=popim.context.path;page.replace(popim.data.baseUri),popim.redirectTo=t;return}if(popim.isback&&popim.data.show!=e){var n=$("#"+popim.data.show);n.addClass("pop__slide-out"),n.off("animationend webkitAnimationEnd"),n.on("animationend webkitAnimationEnd",function(){n.removeClass("pop__slide-out"),popim.data.show=e})}else popim.data.show=e;var r=$("#"+e);!popim.isback&&"home"!=e&&(r.addClass("pop__slide-in"),r.off("animationend webkitAnimationEnd"),r.on("animationend webkitAnimationEnd",function(){r.removeClass("pop__slide-in"),r.css("display","block")})),popim.isback=!1},chat:function(e,t){s.type=e,s.id=t,page(popim.data.baseUri+e+"/chat/"+t)},promptTone:function(){if(popim.data.setting.prompt_tone!="on"||popim.data.mine.prompt_tone!="on")return;document.getElementById("chat-message-audio").play()},autoPlayPromptTone:function(){function e(){var t=document.getElementById("chat-message-audio-source").src,n=document.getElementById("chat-message-audio");n.src="";var r=n.play();r&&r.then(function(){}).catch(function(e){}),n.src=t,$(window).unbind("touchstart",e)}$(window).on("touchstart",e)},connect:function(){var e=popim.data.setting.ws_address,n=e.split(":"),r=n[1].replace("//",""),i=popim.data.setting.appkey;popim.connecter=new Woker(i,{encrypted:n[0]=="wss",enabledTransports:["ws","wss"],wsHost:r,wssPort:n[2],wsPort:n[2],authEndpoint:popim.data.api.authEndpoint});var s=popim.connecter.subscribe("user-"+popim.data.mine.uid);$.each(popim.data.group,function(e,t){popim.listenGroup(t.gid)}),s.on("woker:subscription_succeeded",function(){if(!popim.lastUpdateTime){popim.lastUpdateTime=(new Date).getTime();return}var e=(new Date).getTime();if(e-popim.lastUpdateTime<2e3)return;t.syncData(),popim.lastUpdateTime=e}),s.on("message",popim.onMessage),s.on("revoke",popim.revokeMessage),s.on("friendApply",function(e){t.syncApplyCount(),v.syncApplyList();if(popim.hide){var n={cover:!1,title:"好友申请"};plus.push.createMessage(e.nickname+" 向你发起了好友申请",{path:"apply/detail/"+e.nid},n)}}),s.on("addFriend",function(e){popim.addFriend(e)}),s.on("removeFriend",function(e){popim.deleteFriend(e.uid)}),s.on("addGroup",function(e){popim.listenGroup(e.gid)}),s.on("removeGroup",function(e){popim.deleteGroup(e.gid)});var o=popim.connecter.subscribe("global");o.on("settingChange",function(e){popim.data.setting=e}),popim.connecter.connection.on("state_change",function(e){popim.data.networkState=e.current})},ajax:function(e){var t=e.success||!1,n=e.error||!1,r=(e.type||"get").toLowerCase(),i=typeof e.tip=="undefined"?2:e.tip,s=typeof e.msg=="undefined"?1:e.msg;i?r=="post"?E.dataPosting=1:popim.data.dataLoading=!0:delete e.tip,e.success=function(e){r=="post"?i>1&&e.code==0?(E.dataPosting=2,setTimeout(function(){E.dataPosting=!1},1e3)):E.dataPosting=!1:popim.data.dataLoading=!1;switch(e.code){case-1:popim.redirectTo=!1,page.replace(popim.data.baseUri+"user/login");return;case-2:page(popim.data.baseUri+"user/login"),p.msg(e.msg);return}s&&e.code>0&&p.msg(e.msg),t&&t(e)},e.error=function(e){r=="post"?E.dataPosting=!1:popim.data.dataLoading=!1,n&&n(e)},$.ajax(e)},onMessage:function(e){var t=e.type=="group"||e.from==popim.data.mine.uid?e.to:e.from;popim.data.chatting[e.type+t]||popim.addChatting({id:t,name:t==e.to?e.to_name:e.from_name,avatar:t==e.to?e.to_avatar:e.from_avatar,type:e.type,unread_count:0,items:[]});var n=e.type=="group"?popim.getGroupFromLocal(t):popim.getFriendFromLocal(t);n=n||{},popim.data.chatting[e.type+t].items.push({mid:e.mid,from:e.from,name:n.remark||e.from_name,to:e.to,avatar:e.from_avatar,content:e.content,timestamp:e.timestamp,sub_type:e.sub_type||"message"}),s.scrollBottom(),e.from!=popim.data.mine.uid&&e.sub_type!="notice"&&(popim.data.show!="chat"||s.type!=e.type||s.id!=t)&&popim.data.chatting[e.type+t].unread_count!="99+"&&(popim.data.chatting[e.type+t].unread_count++,popim.data.chatting[e.type+t].unread_count>=100&&(popim.data.chatting[e.type+t].unread_count="99+"));if(e.from!=popim.data.mine.uid&&e.sub_type!="notice"){popim.promptTone();if(popim.hide){var r={cover:!1,title:e.from_name};console.log("/"+e.type+"/chat/"+e.type=="friend"?e.from:e.to),plus.push.createMessage(e.content,{path:"/"+e.type+"/chat/"+(e.type=="friend"?e.from:e.to)},r)}}},revokeMessage:function(e){var t=e.type,n=t!="friend"||e.uid==popim.data.mine.uid?e.id:e.uid,r=e.mid;if(popim.data.chatting[t+n]&&popim.data.chatting[t+n].items)for(var i in popim.data.chatting[t+n].items){var s=popim.data.chatting[t+n].items[i];if(s.mid==r){popim.data.chatting[t+n].items[i].sub_type="notice",popim.data.chatting[t+n].items[i].content="此消息已撤回";return}}},syncChatting:function(e,t){if(!t){console.trace("id undefined");return}var n=e=="friend"?popim.getFriendFromLocal(t):popim.getGroupFromLocal(t);if(!!n)return n={id:t,name:n.name,avatar:n.avatar,type:e},popim.addChatting(n),n;popim.addChatting({id:t,type:e}),popim.ajax({url:e=="friend"?popim.data.api.userDetail:popim.data.api.groupDetail,type:"get",data:{uid:t,gid:t,simple:1},success:function(n){n.code==0&&popim.addChatting({id:t,name:e=="friend"?n.data.remark||n.data.nickname:n.data.remark||n.data.groupname,avatar:n.data.avatar,type:e})}})},addChatting:function(e){popim.data.chatting[e.type+e.id]?$.each(popim.data.chatting[e.type+e.id],function(t,n){typeof e[t]!="undefined"&&(popim.data.chatting[e.type+e.id][t]=e[t])}):Vue.set(popim.data.chatting,e.type+e.id,{id:e.id,name:e.name,avatar:e.avatar,type:e.type,unread_count:e.unread_count||0,items:e.items||[]}),popim.syncUnreadCount(e.type,e.id)},deleteChatting:function(e,t){popim.data.chatting[e+t]&&Vue.delete(popim.data.chatting,e+t),popim.data.show=="chat"&&s.type==e&&s.id==t&&history.back()},syncSetting:function(){popim.ajax({url:popim.data.api.getSetting,success:function(e){e.code==0&&(popim.data.setting=e.data,document.title=e.data.app_name)}})},syncUnreadCount:function(e,t){popim.ajax({url:popim.data.api.messageUnreadCount,type:"get",data:{type:e,id:t},success:function(n){n.code==0&&popim.data.chatting[e+t]&&(popim.data.chatting[e+t].unread_count=n.data)}})},syncUser:function(e){popim.ajax({url:popim.data.api.userDetail,type:"get",data:{uid:e},success:function(t){t.code==0&&($.each(popim.data.friend,function(n,r){r[e]&&(popim.data.friend[n][e].name=t.data.remark||t.data.nickname,popim.data.friend[n][e].avatar=t.data.avatar)}),popim.data.chatting["friend"+e]&&(popim.data.chatting["friend"+e].avatar=t.data.avatar,popim.data.chatting["friend"+e].name=t.data.remark||t.data.nickname))}})},syncGroup:function(e){popim.ajax({url:popim.data.api.groupDetail,type:"get",data:{gid:e,simple:1},success:function(t){if(t.code==0){var n=!1;$.each(popim.data.group,function(r,i){i.gid==e&&(popim.data.group[r].name=t.data.remark||t.data.groupname,popim.data.group[r].avatar=t.data.avatar,popim.data.group[r].uid=t.data.uid,n=!0)}),n||popim.data.group.push({gid:e,avatar:t.data.avatar,name:t.data.remark||t.data.groupname,uid:t.data.uid}),popim.data.chatting["group"+e]&&(popim.data.chatting["group"+e].avatar=t.data.avatar,popim.data.chatting["group"+e].name=t.data.remark||t.data.groupname)}}})},addFriend:function(e){popim.addChatting({id:e.uid,name:e.name,avatar:e.avatar,type:"friend",key:"friend"+e.uid,unread_count:0,items:[]}),popim.syncAddress()},updateGroup:function(e,t){if(popim.data.chatting["group"+e])for(var n in t)typeof popim.data.chatting["group"+e][n]!="undefined"&&Vue.set(popim.data.chatting["group"+e],n,t[n])},updateFriend:function(e,t){if(popim.data.chatting["friend"+e])for(var n in t)typeof popim.data.chatting["friend"+e][n]!="undefined"&&Vue.set(popim.data.chatting["friend"+e],n,t[n]);popim.syncAddress()},deleteFriend:function(e){popim.deleteChatting("friend",e),popim.deleteFriendFromLocal(e)},deleteGroup:function(e){popim.unlistenGroup(e),popim.deleteChatting("group",e),popim.deleteGroupFromLocal(e)},syncAddress:function(e){popim.ajax({url:popim.data.api.friendList,type:"get",success:function(t){t.code==0&&Vue.set(popim.data,"friend",t.data),e&&e.call(this)}})},getFriendFromLocal:function(e){for(var t in popim.data.friend){var n=popim.data.friend[t];if(n[e])return n[e]}},deleteFriendFromLocal:function(e){for(var t in popim.data.friend){var n=popim.data.friend[t];if(n[e]){Vue.delete(popim.data.friend[t],e),Object.values(popim.data.friend[t]).length||Vue.delete(popim.data.friend,t);return}}},getGroupFromLocal:function(e){for(var t in popim.data.group)if(popim.data.group[t].gid==e)return popim.data.group[t]},deleteGroupFromLocal:function(e){for(var t in popim.data.group)if(popim.data.group[t].gid==e){Vue.delete(popim.data.group,t);return}},listenGroup:function(e){var t="group-"+e;if(typeof popim.connecter.channels.channels[t]!="undefined")return;var n=popim.connecter.subscribe(t);n.on("message",popim.onMessage),n.on("updateGroup",function(e){var t=e.gid;popim.updateGroup(t,e)}),n.on("removeGroup",function(e){popim.deleteGroup(e.gid)}),n.on("update",function(t){popim.updateGroup(e,t)}),n.on("revoke",popim.revokeMessage)},unlistenGroup:function(e){popim.connecter.unsubscribe("group-"+e)},check:function(e){if(popim.backToPath){popim.backToPath.charAt(popim.backToPath.length-1)=="/"&&(popim.backToPath=popim.backToPath.substr(0,popim.backToPath.length-1));if(popim.backToPath!=e.path&&popim.backToPath+"/"!=e.path)return console.log("backToPath:"+popim.backToPath),history.back(),!1;popim.backToPath=""}return popim.context=e,!0},setting:function(e,t,n,r,i){h.title=e,h.desc=t,h.btn_name=r,h.content=popim.htmlDecode(n),h.callback=i?i:null,popim.show("setting")},autoUpdateTime:function(){$.each($(".pop__time"),function(e,t){var n=$(t);n.html(Vue.prototype.$formatTime(n.attr("value")))})},checkUsername:function(e){var t=/^[A-Za-z0-9]{1,60}$/;return t.test(e)},isDangerousUrl:function(e){return e=e.toLowerCase(),e.indexOf("javascript")!=-1?!0:e.indexOf("https://demo.popoim.cn/")!=0&&e.indexOf("http")!=0&&e.indexOf("http")!=0?!0:!1},textContent:function(e){return e=e.replace(/\[表情\d+\]/g,"[表情]"),/\!\[.*?\]\(([^\)]+?)\)/.test(e)?e="[图片]":/^file\[(.*?)[\t|\|](.*?)]\((.+?)\)$/.test(e)?e="[文件]":/\[.*?\]\(([^\)]+?)\)/.test(e)?e=e.replace(/\[(.*?)\]\(([^\)]+?)\)/g,"$1"):/^voice\(([^\)]+?)\)$/.test(e)&&(e="[语音]"),e},htmlEncode:function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return t[e]})},htmlDecode:function(e){var t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};return e.replace(/&amp;|&lt;|&gt;|&quot;|&#039;/g,function(e){return t[e]})},scrollIntoView:function(e){var t=e;e=e=="#"?"other":e,$.each($(".pop__firend_list_"+e),function(e,t){t.scrollIntoView()}),$(".pop__friend-list-showletter").text(t).fadeIn(300),setTimeout(function(){$(".pop__friend-list-showletter").fadeOut(300)},500)},resizeWindow:function(){var e=Math.max(document.documentElement.clientHeight,window.innerHeight||0),t=parseFloat(document.documentElement.style.fontSize);popim.rem=t,$(".pop__chat-wrapper").css("height",e),$(".pop__main-page").css("height",e),$(".pop__body").css("height",e-2.1*t)},domain:function(){var e="https:"==document.location.protocol?!0:!1,t=window.location.host;return e?domain="https://"+t:domain="http://"+t,domain},supportH5Plus:function(){return typeof plus!="undefined"&&plus.audio&&plus.uploader&&plus.os.name!="Android"?!0:!1}};var e=new Vue({el:"#welcome",data:{popim:popim.data}}),t=new Vue({el:"#home",data:{popim:popim.data,tab:"chatting",unreadApplyCount:0,slideDistance:0,explore_url:""},watch:{tab:function(e,t){e=="friend"&&!this.hasSyncAddress&&(popim.syncAddress(),this.hasSyncAddress=!0),e=="explore"&&(this.explore_url||(this.explore_url=popim.data.setting.explore_url))}},computed:{unreadMessageCount:function(){var e=0;return $.each(popim.data.chatting,function(t,n){if(e=="99+")return;if(n.unread_count=="99+"){e="99+";return}e+=n.unread_count}),e},chattingItems:function(){return Object.values(this.popim.chatting).sort(function(e,t){var n=e.items.length&&e.items.slice(-1)[0],r=t.items.length&&t.items.slice(-1)[0],i=n&&n.timestamp?n.timestamp:0,s=r&&r.timestamp?r.timestamp:0;return i>s?-1:i<s?1:0})},stateName:function(){var e={initialized:"",connected:"",connecting:"连接中...",unavailable:"网络暂时不可用，稍后重试",failed:"连接断开，请点击刷新",disconnected:"连接断开"};return e[popim.data.networkState]}},methods:{refresh:function(){window.location.reload()},syncData:function(e){var n=(new Date).getTime();if(n-popim.lastUpdateTime<2e3){console.log("syncData return without ajax");return}popim.lastUpdateTime=n;var r={};e&&(r.simple=1),popim.ajax({url:popim.data.api.baseInfo,type:"get",data:r,success:function(n){switch(n.code){case 0:popim.data.mine=n.data.mine;if(e)return;$.each(n.data.chatting,function(e,t){var n=popim.data.chatting[e]?popim.data.chatting[e].items:[];Vue.set(popim.data.chatting,e,t);if(!n.length||!t.items.length)return;var r=t.items[0].mid;r>n[n.length-1].mid&&n.push(t.items[0]),popim.data.chatting[e].items=n}),s.getmessage(!0,null,!0),this.hasSyncAddress=!1,popim.data.group=n.data.group,popim.data.setting=n.data.setting,t.unreadApplyCount=n.data.mine.unread_friend_apply_count,document.title=n.data.setting.app_name,popim.connectionInited||(popim.connectionInited=!0,popim.connect()),t.tab=="friend"&&(popim.syncAddress(),this.hasSyncAddress=!0),popim.redirectTo&&(page(popim.redirectTo),popim.redirectTo="");return;case 101:page(popim.data.baseUri+"user/login");return}}})},syncApplyCount:function(){popim.ajax({url:popim.data.api.friendApplyCount,type:"get",success:function(e){e.code==0&&(t.unreadApplyCount=e.data)}})},lastMessage:function(e){return e=e.items.length&&e.items.slice(-1)[0],e?{content:popim.textContent(e.content),timestamp:e.timestamp}:{content:"",timestamp:0}},touchStart:function(e,t){t.startX=e.touches[0].clientX,t.startY=e.touches[0].clientY,this.restSlide(t)},touchMove:function(e,t){var n=e.changedTouches[0].clientX,r=e.changedTouches[0].clientY;t.direction||(Math.abs(n-t.startX)>Math.abs(r-t.startY)?t.direction="left-right":t.direction="up-down");if(t.direction=="up-down")return;var i=(n-t.startX)*-1/popim.rem;if(!t.slideDistance&&i<0)return;if(t.slideDistance==2&&i>0)return;i>0?Vue.set(t,"slideDistance",i>2?2:i):Vue.set(t,"slideDistance",i<-2?0:2+i),e.preventDefault()},touchEnd:function(e,t){if(t.direction=="left-right"){var n=e.changedTouches[0].clientX;t.startX-n>30?Vue.set(t,"slideDistance",2):Vue.set(t,"slideDistance",0),t.startX-n<-30&&Vue.set(t,"slideDistance",0)}t.direction=!1,t.startX=0,t.startY=0},restSlide:function(e){$.each(this.chattingItems,function(t,n){if(e==n)return;Vue.set(n,"slideDistance",0)})},deleteItem:function(e,t){popim.ajax({url:popim.data.api.deleteChat,type:"post",data:{type:t.type,id:t.id},success:function(e){e.code==0&&popim.deleteChatting(t.type,t.id)}})},showTestInfo:function(){p.msg("扩展功能入口，开发者可以自行扩展")},scrollIntoView:popim.scrollIntoView}}),n=function(e){if(!popim.check(e))return;popim.data.mine.uid||t.syncData(),popim.show("home")};page(popim.data.baseUri,n);var r=new Vue({el:"#login",data:{popim:popim.data,username:"",password:"",captcha:""},methods:{login:function(){if(this.username=="")return p.msg("用户名不能为空！");if(this.password=="")return p.msg("密码不能为空！");if(popim.data.setting.login_captcha=="on"&&this.captcha=="")return p.msg("验证码不能为空！");var e=this,t={username:this.username,password:this.password,captcha:this.captcha};if(typeof plus!="undefined"&&plus.push){var n=plus.push.getClientInfo();t.cid=n.clientid}popim.ajax({url:popim.data.api.loginCheck,type:"post",tip:0,data:t,success:function(t){t.code==0?page.replace(popim.data.baseUri):e.switchCaptcha()}})},switchCaptcha:function(){popim.data.setting.login_captcha=="on"&&(this.$refs.captchaImg.src=popim.data.api.loginCaptcha+"?rand="+Math.random())}}}),i=new Vue({el:"#join",data:{popim:popim.data,username:"",nickname:"",password:"",sign:"",captcha:""},methods:{join:function(){if(this.username=="")return p.msg("用户名不能为空！");if(this.nickname=="")return p.msg("昵称不能为空！");if(this.password=="")return p.msg("密码不能为空！");if(popim.data.setting.register_captcha=="on"&&this.captcha=="")return p.msg("验证码不能为空！");if(!popim.checkUsername(this.username))return p.msg("用户名只能包含字母和数字，长度小于60");var e=this;popim.ajax({url:popim.data.api.userJoin,type:"post",tip:0,data:{username:this.username,password:this.password,nickname:this.nickname,sign:this.sign,captcha:this.captcha},success:function(t){if(t.code==0){page.replace(popim.data.baseUri+"user/login");return}e.switchCaptcha()}})},switchCaptcha:function(){popim.data.setting.register_captcha=="on"&&(this.$refs.captchaImg.src=popim.data.api.joinCaptcha+"?rand="+Math.random())}}});page(popim.data.baseUri+"friend/chat/:uid",function(e){if(!popim.check(e))return;s.id=e.params.uid,s.type="friend",popim.show("chat"),popim.syncUser(s.id),s.getmessage(!0,null,!0)}),page(popim.data.baseUri+"group/chat/:gid",function(e){if(!popim.check(e))return;s.id=e.params.gid,s.type="group",popim.show("chat"),popim.syncGroup(s.id),s.getmessage(!0,null,!0)});var s=new Vue({el:"#chat",data:{popim:popim.data,id:0,type:"friend",message:"",voice:!1,panel:!1,voiceTips:"",voiceBtnTips:"按住 说话",messageLock:!1,messageEnd:!1,tapMenuShow:!1,tapMenuLeft:0,tapMenuTop:0,supportRevoke:!1},computed:{messageList:function(){return this.lastInsertTime=this.lastTime=0,this.popim.chatting[this.type+this.id]?this.popim.chatting[this.type+this.id].items||[]:[]},name:function(){if(!this.id)return"";var e=this.popim.chatting[this.type+this.id]||!1;return e?e.remark||e.name:""},inputWidth:function(){var e=6.1;return this.popim.setting.voice=="on"&&(e-=.88),this.popim.setting.emoji=="on"&&(e-=.88),e+"rem"},mid:function(){var e=this.popim.chatting[this.type+this.id];return!e||!e.items||!e.items.length?null:e.items[0].mid||null},supportCopy:function(){return typeof document.execCommand=="function"}},methods:{reset:function(){popim.ajax({url:popim.data.api.updateLastReadTime,type:"post",tip:0,data:{id:this.id,type:this.type}}),this.popim.chatting[this.type+this.id]&&this.popim.chatting[this.type+this.id].items&&(this.popim.chatting[this.type+this.id].items=this.popim.chatting[this.type+this.id].items.slice(-20),this.popim.chatting[this.type+this.id].unread_count=0),this.voiceTips=this.message="",this.messageEnd=this.messageLock=this.panel=this.voice=!1,this.voiceBtnTips="按住 说话",this.lastTime=this.lastInsertTime=0},needInsertTime:function(e){return e<this.lastTime&&(this.lastInsertTime=0),this.lastTime=e,(new Date).getTime()>e&&e-this.lastInsertTime>60?(this.lastInsertTime=e,!0):!1},send:function(){this.panel=!1;if(this.message=="")return;that=this,popim.ajax({url:popim.data.api.messageSend,type:"post",tip:0,data:{to:this.id,content:this.message,type:this.type},success:function(e){},error:function(){p.msg("发送失败，网络/服务器不可用")}}),that.message=""},openEmotion:function(){if(this.panel=="face"){this.panel=!1;return}this.voice=!1,this.panel="face";if(!this.emotion_swiper){var e="",t=0,n,r=100,i=21;for(var s=0;s<=Math.floor(r/i);s++){e+='<div class="swiper-slide"><div class="pop__face-list">';for(var o=0;o<i;o++){n=t++;if(n>r)break;e+='<span><img class="face" src="/static/h5/img/emotion/face01/'+n+'.png" title="[表情'+n+']"/></span>'}e+="</div></div>"}$("#pop__emotion .swiper-wrapper").html(e),this.$nextTick(function(){this.emotion_swiper=new Swiper("#pop__emotion",{pagination:".pop__emotion-pagination",paginationClickable:!0})})}},openFunction:function(){this.panel=this.panel=="function"?!1:"function",this.voice=!1},closePanel:function(){this.panel=!1},selectEmotion:function(e){this.message+=e.target.title},scrollBottom:function(e){this.$nextTick(function(){(e||$(".pop__chat-content").height()-($(".pop__chat-msg-panel").scrollTop()+$(".pop__chat-msg-panel").height())<200)&&setTimeout(function(){$(".pop__chat-msg-panel").scrollTop($(".pop__chat-content").height()+1e3)},200)})},readImageAndSend:function(e){var t=e.getAsFile(),n=new FormData,r=encodeURIComponent("截图.png");n.append("file",t,r),popim.ajax({url:popim.data.api.uploadImage,type:"POST",data:n,contentType:!1,processData:!1,tip:1,success:function(e){if(e.code==0){var t="![图片]("+e.data.src+")";popim.ajax({url:popim.data.api.messageSend,type:"post",tip:0,data:{to:s.id,content:t,type:s.type},success:function(e){}})}}})},paste:function(e){var t=e.clipboardData,n=0,r,i,s;if(t){r=t.items;if(!r)return;i=r[0],s=t.types||[];for(;n<s.length;n++)if(s[n]==="Files"){i=r[n];break}i&&i.kind==="file"&&i.type.match(/^image\//i)&&this.readImageAndSend(i)}},uploadImage:function(e){this.panel=!1;var t=new FormData,n=e.target;t.append("file",n.files[0]),popim.ajax({url:popim.data.api.uploadImage,type:"POST",data:t,contentType:!1,processData:!1,tip:1,success:function(e){if(e.code==0){var t="![图片]("+e.data.src+")";popim.ajax({url:popim.data.api.messageSend,type:"post",tip:0,data:{to:s.id,content:t,type:s.type},success:function(e){}})}}}),n.parentNode.reset()},uploadFile:function(e){this.panel=!1;var t=new FormData,n=e.target;t.append("file",n.files[0]),popim.ajax({url:popim.data.api.uploadFile,type:"POST",data:t,contentType:!1,processData:!1,tip:1,success:function(e){if(e.code==0){var t="file["+e.data.name+"	"+e.data.size+"]("+e.data.src+")";popim.ajax({url:popim.data.api.messageSend,type:"post",tip:0,data:{to:s.id,content:t,type:s.type},success:function(e){}})}}}),n.parentNode.reset()},toggleVoice:function(){this.voice=!this.voice;if(this.voice){if(popim.supportH5Plus()){this.tryPlusAudio();return}this.tryBrowserAudio()}},tryBrowserAudio:function(){navigator.mediaDevices===undefined&&(popim.data.mine.username=="popimtrace"&&alert(Object.keys2(navigator)),navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===undefined&&(navigator.mediaDevices.getUserMedia=function(e){var t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if(!t){var n=new Error;return n.name="当前浏览器不支持语音",Promise.reject(n)}return new Promise(function(n,r){t.call(navigator,e,n,r)})}),navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){e.getTracks().forEach(function(e){e.stop()})}).catch(function(e){s.voice=!1,s.showUserMediaError(e)})},tryPlusAudio:function(){s.recorder=plus.audio.getRecorder(),s.recorder.record({filename:"_doc/audio/",format:"mp3"},function(e){console.log("path:"+e)},function(e){s.voice=!1,p.msg("录音出现异常: "+e.message)}),setTimeout(function(){s.recorder.stop()},50)},beginVoiceRecord:function(e){e.target.posStart=e.touches[0].pageY,this.voiceBtnTips="松开 发送",this.voiceTips="手指上划，取消发送";if(popim.supportH5Plus()){this.plusVoiceRecord();return}this.browserVoiceRecord()},browserVoiceRecord:function(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audio_context=new AudioContext}catch(e){p.msg(e);return}navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){var t=s.audio_context.createMediaStreamSource(e);s.recorder=new Recorder(t),s.recorder.record()}).catch(function(e){s.showUserMediaError(e)})},plusVoiceRecord:function(){s.recorder=plus.audio.getRecorder(),this.cancelVoiceRecord=!1,s.recorder.record({filename:"_doc/audio/",format:"mp3"},function(e){console.log("recordpath:"+e);if(!s.cancelVoiceRecord){var t=plus.uploader.createUpload(popim.domain()+"/"+popim.data.api.uploadFile,{method:"POST",blocksize:2048e3,priority:100,timeout:30},function(e,t){if(t==200){var n=JSON.parse(e.responseText);if(n.code!=0){p.msg(n.msg);return}var r="voice("+n.data.src+")";popim.ajax({url:popim.domain()+"/"+popim.data.api.messageSend,type:"post",tip:0,data:{to:s.id,content:r,type:s.type},success:function(e){}})}else p.msg("Upload failed: "+t)});t.addFile(e,{key:"file"}),t.start()}},function(e){s.voice=!1,p.msg("录音出现异常: "+e.message)})},browserVoiceStop:function(){this.recorder.stop(),this.recorder.clear(),this.audio_context.close()},plusRecordVoiceStop:function(){this.recorder.stop()},sendVoice:function(e){voiceBtnTips="按住 说话";if(!this.recorder)return;if(popim.supportH5Plus()){this.voiceTips=="松开手指，取消发送"&&(this.cancelVoiceRecord=!0),this.plusRecordVoiceStop(),this.voiceTips="";return}if(this.voiceTips=="松开手指，取消发送"){this.voiceTips="",this.browserVoiceStop(),this.voiceTips="";return}this.voiceTips="",this.recorder.stop(),this.recorder.exportWAV(function(e){var t=e,n=new FormData,r=encodeURIComponent("voice_recording_"+(new Date).getTime()+".wav");n.append("file",t,r),popim.ajax({url:popim.data.api.uploadFile,type:"POST",data:n,contentType:!1,processData:!1,tip:1,success:function(e){if(e.code==0){var t="voice("+e.data.src+")";popim.ajax({url:popim.data.api.messageSend,type:"post",tip:0,data:{to:s.id,content:t,type:s.type},success:function(e){}})}}}),s.recorder.clear(),s.audio_context.close()})},cancelVoice:function(e){e.preventDefault();var t=e.targetTouches[0].pageY;e.target.posStart-t>50?(this.voiceTips="松开手指，取消发送",this.voiceBtnTips="松开 结束"):(this.voiceTips="手指上划，取消发送",this.voiceBtnTips="松开 发送")},showUserMediaError:function(e){var t=e.name;switch(t){case"NotAllowedError":case"PermissionDeniedError":t=e.name+" 浏览器未获得麦克风权限";break;case"NotFoundError":case"DevicesNotFoundError":t=e.name+"录音设备未找到";break;case"NotSupportedError":t=e.name+"该浏览器不支持录音功能"}p.msg(t)},getmessage:function(e,t,n){if(this.messageLock||this.messageEnd||!this.id)return;var r={id:this.id,type:this.type},i=20;r.limit=i,!n&&this.mid&&(r.mid=this.mid);var o=this;this.messageLock=!0,popim.ajax({url:popim.data.api.messageGet,type:"get",data:r,success:function(r){if(r.code==0){if(!r.data.length||r.data.length<i)o.messageEnd=!0;s.popim.chatting[s.type+s.id]||popim.syncChatting(s.type,s.id),n||$.each(s.popim.chatting[s.type+s.id].items,function(e,t){r.data.push(t)}),s.popim.chatting[s.type+s.id].items=r.data,t&&o.$nextTick(t),s.scrollBottom(e||!1),setTimeout(function(){o.messageLock=!1,o.lastInsertTime=o.lastTime=0},100)}},error:function(){o.messageLock=!1}})},handleScroll:function(e){this.tapMenuShow=!1;var t=$(e.target),n=t.scrollTop(),r=t.prop("scrollHeight"),i=function(){var e=t.prop("scrollHeight"),n=e-r;n>0&&t.scrollTop(n)};n<=0&&this.getmessage(!1,i)},showtapMenu:function(e,t,n,r,i,s){this.supportRevoke=!0;if(i!=popim.data.mine.uid)if(t=="group"){var o=popim.getGroupFromLocal(n);if(!o||o.uid!=popim.data.mine.uid)this.supportRevoke=!1}else this.supportRevoke=!1;this.tapMenuShow=!0;var u=this,a=$(e.currentTarget);this.$nextTick(function(){var e=a.position(),i=$(u.$refs.menu);u.$refs.menu.type=t,u.$refs.menu.id=n,u.$refs.menu.mid=r,u.$refs.menu.content=s,u.tapMenuLeft=e.left+a.width()/2-i.width()/2+"px",u.tapMenuTop=e.top-i.height()-8+"px"})},copy:function(){function t(e){if(document.selection){var t=document.body.createTextRange();t.moveToElementText(e),t.select()}else if(window.getSelection){var t=document.createRange();t.selectNode(e),window.getSelection().removeAllRanges(),window.getSelection().addRange(t)}}this.closeTapMenu(100);var e=this.$refs.menu.content,n=document.createElement("DIV");n.textContent=e,document.body.appendChild(n),t(n),document.execCommand("copy"),n.remove()},revoke:function(){this.closeTapMenu(100),this.$refs.menu.mid&&popim.ajax({url:popim.data.api.messageRevoke,type:"post",data:{type:this.$refs.menu.type,id:this.$refs.menu.id,mid:this.$refs.menu.mid},success:function(){}}),this.$refs.menu.mid=this.$refs.menu.type=this.$refs.menu.mid=this.$refs.menu.content=""},closeTapMenu:function(e){if(!e){s.tapMenuShow=!1;return}setTimeout(function(){s.tapMenuShow=!1},e)},touchStart:function(e){$(".pop__chat-tap-menu").has(e.target).length==0&&this.closeTapMenu()},resizeWindow:function(){setTimeout(function(){window.scrollTo(0,document.body.scrollTop+1),document.body.scrollTop>=1&&window.scrollTo(0,document.body.scrollTop-1)},10),popim.resizeWindow()}}}),o=new Vue({el:"#group_list",data:{popim:popim.data}});page(popim.data.baseUri+"group/list",function(e){if(!popim.check(e))return;popim.show("group_list")});var u=new Vue({el:"#user_detail",data:{popim:popim.data,remarkname:"",username:"",nickname:"",sign:"",avatar:"",isFriend:!1,uid:0,gid:0,accountState:"normal"},methods:{chat:function(){popim.chat("friend",this.uid)},deleteFriend:function(){var e=this.uid;d.warningConfirm('确认将好友"'+(this.remarkname||this.nickname)+'"删除么？',function(){popim.ajax({url:popim.data.api.friendDelete,type:"post",data:{friend_uid:e},success:function(t){t.code==0&&(popim.deleteFriend(e),history.go(-2))}})})}}});page(popim.data.baseUri+"user/detail/:uid",a),page(popim.data.baseUri+"user/detail/:uid/gid/:gid",a);var f=new Vue({el:"#forbidden",data:{popim:popim.data,selectedValue:0,uid:0,gid:0},methods:{action:function(){if(!this.selectedValue)return;var e=this.selectedValue;popim.ajax({url:popim.data.api.groupForbiddenUser,type:"post",data:{uid:this.uid,gid:this.gid,time:e},success:function(e){e.code==0&&history.go(-2)}})}}});page(popim.data.baseUri+"group/forbidden/:gid/:uid",function(e){if(!popim.check(e))return;f.uid=e.params.uid,f.gid=e.params.gid,popim.show("forbidden")}),page(popim.data.baseUri+"group/detail/:gid",function(e){if(!popim.check(e))return;var t=e.params.gid;l.gid=t,popim.ajax({url:popim.data.api.groupDetail,type:"get",data:{gid:t},success:function(e){e.code==0&&(l.members=e.data.members,l.groupname=e.data.info.groupname,l.remark=e.data.info.remark,l.uid=e.data.info.uid,l.forbid_speaking=e.data.info.forbid_speaking)}}),popim.show("group_detail")});var l=new Vue({el:"#group_detail",data:{popim:popim.data,gid:0,uid:0,groupname:"",remark:"",forbid_speaking:0,members:[]},computed:{isGroupOwner:function(){return this.uid==this.popim.mine.uid}},methods:{leaveGroup:function(){var e=this.gid;d.warningConfirm("确认要退出群组么？",function(){popim.ajax({url:popim.data.api.groupLeave,type:"post",data:{gid:e},success:function(t){t.code==0&&(popim.deleteGroup(e),page(popim.data.baseUri))}})})},deleteGroup:function(){var e=this.gid;d.warningConfirm("确认要解散群组么？",function(){popim.ajax({url:popim.data.api.groupDelete,type:"post",data:{gid:e},success:function(t){t.code==0&&(popim.deleteGroup(e),page(popim.data.baseUri))}})})},toggleForbidSpeaking:function(){this.forbid_speaking=this.forbid_speaking==1?0:1;var e=this.gid,t=this.forbid_speaking;popim.ajax({url:popim.data.api.groupForbiddenAll,type:"post",data:{gid:e,value:t},success:function(e){}})},avatarLink:function(e){if(this.popim.setting.member_detail=="off"&&!this.isGroupOwner)return"";var t=popim.data
.baseUri+"user/detail/"+e;return this.isGroupOwner&&this.popim.mine.uid!=e&&(t+="/gid/"+this.gid),t}}});page(popim.data.baseUri+"group/members/:gid",function(e){if(!popim.check(e))return;c.reset(),popim.show("group_members"),c.gid=e.params.gid,c.syncGroupInfo(),c.nextPage()});var c=new Vue({el:"#group_members",data:{popim:popim.data,gid:0,uid:0,index:0,groupname:"",remark:"",members:[],ended:!1},computed:{isGroupOwner:function(){return this.uid==this.popim.mine.uid}},methods:{reset:function(){this.gid=this.uid=this.index=0,this.groupname=this.remark="",this.members=[],this.ended=!1},syncGroupInfo:function(){var e=this;popim.ajax({url:popim.data.api.groupDetail,type:"get",data:{gid:this.gid,simple:1},success:function(t){t.code==0&&(e.groupname=t.data.groupname,e.remark=t.data.remark,e.uid=t.data.uid)}})},nextPage:function(){var e=this,t=32;popim.ajax({url:popim.data.api.groupMembers,type:"get",data:{gid:this.gid,index:this.index,limit:t},success:function(n){if(n.code!=0)return;var r=Object.values(n.data);r.length<t&&(e.ended=!0),$.each(r,function(t,n){e.index<n.index&&(e.index=n.index);var r=!0;$.each(e.members,function(e,t){t.uid==n.uid&&(r=!1)}),r&&e.members.push(n)})}})},avatarLink:function(e){if(this.popim.setting.member_detail=="off"&&!this.isGroupOwner)return"";var t=popim.data.baseUri+"user/detail/"+e;return this.popim.mine.uid==this.uid&&e!=this.popim.mine.uid&&(t+="/gid/"+this.gid),t}}}),h=new Vue({el:"#setting",data:{popim:popim.data,title:"设置",desc:"",content:"",btn_name:"确定",callback:null},methods:{action:function(){this.callback.call(this)}}}),p=new Vue({el:"#dialog",data:{content:"",show:!1,callback:null},methods:{msg:function(e){this.content=e,this.callback=null,this.show=!0},confirm:function(e,t){this.content=e,this.callback=t,this.show=!0},hide:function(){this.show=!1},action:function(){this.callback.call(this)}}}),d=new Vue({el:"#actionsheet",data:{content:"",show:!1,warning:!1,callback:null},methods:{confirm:function(e,t){this.warning=!1,this.content=e,this.callback=t,this.show=!0,page(popim.data.baseUri+"actionsheet/confirm")},warningConfirm:function(e,t){this.warning=!0,this.content=e,this.callback=t,this.show=!0,page(popim.data.baseUri+"actionsheet/confirm")},cancel:function(){history.back()},action:function(){this.callback.call(this)}}});page(popim.data.baseUri+"actionsheet/confirm",function(e){if(!popim.check(e))return;d.show=!0}),page.exit(popim.data.baseUri+"actionsheet/*",function(e,t){d.show=!1,t()});var v=new Vue({el:"#search",data:{popim:popim.data,searchText:"",applyList:[],showApplyList:!0},methods:{focus:function(){this.$refs.input.focus(),this.showApplyList=!1},cancel:function(){this.showApplyList=!0,this.searchText=""},clear:function(){this.searchText="",this.focus()},blur:function(){if(this.searchText)return;this.cancel()},operationName:function(e){return e=="not_operated"?'<a href="javascript:;" class="pop__btn-primary-mini">查看</a>':e=="agree"?"<label>已同意</label>":e=="refuse"?"<label>已拒绝</label>":e},search:function(){popim.ajax({url:popim.data.api.getUserByName,type:"get",msg:!1,data:{username:this.searchText},success:function(e){e.code==0&&typeof e.data.uid!="undefined"?page(popim.data.baseUri+"user/detail/"+e.data.uid):p.msg("未找到该用户")}})},syncApplyList:function(){popim.ajax({url:popim.data.api.friendApplyList,type:"get",success:function(e){e.code==0&&(v.applyList=e.data)}})}}});page(popim.data.baseUri+"friend/search",function(e){if(!popim.check(e))return;v.syncApplyList(),popim.show("search")});var m=new Vue({el:"#mine_detail",data:{popim:popim.data}});page(popim.data.baseUri+"mine/detail",function(e){if(!popim.check(e))return;popim.show("mine_detail")});var g=new Vue({el:"#set_avatar",data:{popim:popim.data},methods:{uploadAvatar:function(e){var t=new FormData,n=e.target;t.append("file",n.files[0]),popim.ajax({url:popim.data.api.uploadAvatar,type:"POST",data:t,contentType:!1,processData:!1,tip:1,success:function(e){if(e.code==0){var t=e.data.src;popim.ajax({url:popim.data.api.userUpdate,type:"post",data:{avatar:t},success:function(e){popim.data.mine.avatar=t}})}}}),n.parentNode.reset()}}});page(popim.data.baseUri+"setting/avatar",function(e){if(!popim.check(e))return;popim.show("set_avatar")}),page(popim.data.baseUri+"setting/nickname",function(e){if(!popim.check(e))return;popim.setting("设置名字","",popim.data.mine.nickname,"完成",function(){popim.ajax({url:popim.data.api.userUpdate,type:"post",data:{nickname:h.content},success:function(e){e.code==0&&(popim.data.mine.nickname=popim.htmlEncode(h.content),history.back())}})})}),page(popim.data.baseUri+"setting/sign",function(e){if(!popim.check(e))return;popim.setting("设置个性签名","",popim.data.mine.sign,"完成",function(){popim.ajax({url:popim.data.api.userUpdate,type:"post",data:{sign:h.content},success:function(e){e.code==0&&(popim.data.mine.sign=popim.htmlEncode(h.content),history.back())}})})});var y=new Vue({el:"#setting_others",data:{popim:popim.data,prompt_tone:"on"},methods:{togglePromptTone:function(){this.prompt_tone=this.prompt_tone=="on"?"off":"on";var e=this.prompt_tone;popim.ajax({url:popim.data.api.userUpdate,type:"post",data:{prompt_tone:e},success:function(t){t.code==0&&(popim.data.mine.prompt_tone=e)}})},logout:function(){var e={logout_uid:popim.data.mine.uid};if(typeof plus!="undefined"&&plus.push){var n=plus.push.getClientInfo();e.cid=n.clientid}popim.ajax({url:popim.data.api.logout,type:"POST",data:e,tip:0,success:function(e){popim.backToPath=popim.data.baseUri,history.back(),setTimeout(function(){if(popim.connecter)try{popim.connecter.unsubscribe("user-"+popim.data.mine.uid),$.each(popim.data.group,function(e,t){popim.unlistenGroup(t.gid)}),popim.connectionInited=!1,popim.connecter.disconnect()}catch(e){console.log(e)}popim.data.chatting=popim.data.friend=popim.data.group=[],popim.data.mine={},t.hasSyncAddress=!1,t.tab="chatting",t.syncData()},500)}})}}});page(popim.data.baseUri+"setting/others",function(e){if(!popim.check(e))return;y.prompt_tone=popim.data.mine.prompt_tone,popim.show("setting_others")}),page(popim.data.baseUri+"friend/send_apply/:uid",function(e){if(!popim.check(e))return;popim.setting("发送验证","你需要发送验证申请，等对方通过","我是"+popim.data.mine.nickname,"发送",function(){popim.ajax({url:popim.data.api.friendApply,type:"post",data:{friend_uid:e.params.uid,postscript:h.content},success:function(e){e.code==0&&history.back()}})})});var b=new Vue({el:"#apply_detail",data:{popim:popim.data,nid:0,nickname:"",username:"",avatar:"",postScript:"",operation:""},methods:{agree:function(){popim.ajax({url:popim.data.api.friendAgree,type:"post",data:{nid:this.nid},success:function(e){e.code==0&&(t.syncApplyCount(),popim.syncAddress(),history.back())}})},refuse:function(){popim.ajax({url:popim.data.api.friendRefuse,type:"post",data:{nid:this.nid},success:function(e){e.code==0&&(t.syncApplyCount(),history.back())}})}}});page(popim.data.baseUri+"apply/detail/:nid",function(e){if(!popim.check(e))return;var t=e.params.nid;b.username=b.nickname=b.avatar=b.postScript=b.operation="",b.nid=t,popim.ajax({url:popim.data.api.friendApplyDetail,type:"get",data:{nid:t},success:function(e){if(e.code==0){b.avatar=e.data.avatar,b.nickname=e.data.nickname,b.username=e.data.username;var t=e.data.data?JSON.parse(e.data.data):{};b.postScript=t.postscript||"",b.operation=e.data.operation}}}),popim.show("apply_detail")});var w=new Vue({el:"#group_member_operation",data:{popim:popim.data,gid:0,type:"add",members:[],selectedItems:[]},methods:{action:function(){if(this.type=="create"){popim.ajax({url:popim.data.api.groupCreate,type:"post",data:{members:this.selectedItems},success:function(e){if(e.code==0){var t=e.data.gid;popim.addChatting({id:t,name:e.data.groupname,avatar:e.data.avatar,type:"group",unread_count:0,items:[]}),popim.listenGroup(e.data.gid),popim.chat("group",e.data.gid)}}}),this.$refs.form.reset(),this.selectedItems=[];return}var e=this.gid;popim.ajax({url:this.type=="add"?popim.data.api.groupMemberAdd:popim.data.api.groupMemberDelete,type:"post",data:{members:this.selectedItems,gid:e},success:function(t){page.replace(popim.data.baseUri+"group/chat/"+e)}}),this.$refs.form.reset(),this.selectedItems=[]},scrollIntoView:popim.scrollIntoView}});page(popim.data.baseUri+"group/create",function(e){if(!popim.check(e))return;w.type="create",w.gid=e.params.gid,w.members=popim.data.friend,popim.show("group_member_operation")}),page(popim.data.baseUri+"group/memberadd/:gid",function(e){if(!popim.check(e))return;w.type="add",w.gid=e.params.gid,popim.show("group_member_operation"),popim.ajax({url:popim.data.api.groupMembers,type:"get",data:{gid:e.params.gid},success:function(e){if(e.code==0){var n=e.data,r={},i=function(){$.each(popim.data.friend,function(e,t){var i=[];$.each(t,function(e,t){var r=t.uid;n[r]||i.push(t)}),i.length&&(r[e]=i)}),w.members=r};if(!t.hasSyncAddress){popim.syncAddress(i);return}i()}}})}),page(popim.data.baseUri+"group/memberdel/:gid",function(e){if(!popim.check(e))return;w.type="del",w.gid=e.params.gid,popim.show("group_member_operation"),popim.ajax({url:popim.data.api.groupMembers,type:"get",data:{gid:e.params.gid,pinyin:!0,exclude:popim.data.mine.uid},success:function(e){e.code==0&&(w.members=e.data)}})}),Vue.component("chat-message",{props:["from","name","content","time","avatar","mid","popim","sub_type"],data:function(){return{src:"",state:"paused",duration:0,htmlContent:""}},computed:{messageType:function(){content=this.content.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;").replace(/\[表情(\d+)\]/g,'<img class="pop__chat-msg-face" src="/static/h5/img/emotion/face01/$1.png" title="[表情$1]"/>'),content=content.replace(/\{POPBASEURI\}/g,popim.data.baseUri),this.htmlContent=content;var e,t,n="pop__chat-msg-text";if(/^voice\(([^\)]+?)\)$/.exec(this.content))return this.src=RegExp.$1,"pop__chat-msg-voice";if(t=/\!\[.*?\]\(([^\)]+?)\)/.exec(content)){e=t[1];if(popim.isDangerousUrl(e))return n;n="pop__chat-msg-picture",content='<img src="'+e+'" />'}else if(t=/^file\[(.*?)[\t|\|](.*?)]\((.+?)\)$/.exec(content)){var r=t[1],i=t[2];e=t[3];if(popim.isDangerousUrl(e))return n;n="pop__chat-msg-file";var s=r.lastIndexOf("."),o=s?r.substring(s+1,r.length).toUpperCase():"file";o=o.length>3?o.substring(0,4).toLowerCase():o,o=="MP4"||o=="MOV"||o=="3GP"?(n="pop__chat-msg-video",content='<video src="'+e+'"></video>'):content='<div class="pop__chat-msg-file-cover">                         <i class="pop__chat-msg-icon">'+o+'</i>                      </div>                      <div class="pop__chat-msg-file-info">                          <span class="pop__chat-msg-file-name"><a href="'+e+'" download="'+r+'">'+r+'</a></span>                          <span class="pop__chat-msg-file-size">'+i+"</span>                      </div>"}else/\[.*?\]\(([^\)]+?)\)/.test(content)?(content=content.replace(/\[(.*?)\]\(((?=http|\/\/)[^\)]+?)\)/g,'<a href="$2" target="_blank">$1</a>'),content=content.replace(/\[(.*?)\]\((\/[^\)]+?)\)/g,'<a href="$2">$1</a>')):/^http[s]?:\/\/(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+$/.test(content)&&(content='<a href="'+content+'" target="_blank">'+content+"</a>");return this.htmlContent=content,n},type:function(){return s.type},avatarLink:function(){if(this.type=="group"&&popim.data.setting.member_detail=="off"&&!this.isGroupOwner)return"";var e=popim.data.baseUri+"user/detail/"+this.from;return this.type=="group"&&this.popim.mine.uid!=this.from&&this.isGroupOwner&&(e+="/gid/"+s.id),e},isGroupOwner:function(){if(this.type!="group")return!1;var e=popim.getGroupFromLocal(this.to);return e&&e.uid==popim.data.mine.uid},to:function(){return s.id}},methods:{play:function(){if(this.messageType!="pop__chat-msg-voice")return;$.each($("audio"),function(e,t){!t.paused&&t.pause()});var e=this.$refs.voice;e.paused&&(e.currentTime=0,e.play())},setState:function(e){this.state=e.type=="play"?"running":"paused"},durationChange:function(){var e=this.$refs.voice;if(e){this.duration=Math.ceil(e.duration);if(this.duration<0||this.duration==Infinity)this.duration=0}},showtapMenu:function(e,t,n,r,i,o){return s.showtapMenu(e,t,n,r,i,o),!1},textContent:function(){return popim.textContent(this.content)},noticeContent:function(){return this.type=="group"&&popim.data.setting.member_detail=="off"&&!this.isGroupOwner?this.textContent():this.htmlContent}},template:'<li v-if="sub_type!=\'notice\'" :class="{\'pop__chat-msg-me\':popim.mine.uid==from, \'pop__chat-msg-others\':popim.mine.uid!=from}" :key="mid">                      <span v-if="popim.mine.uid!=from" class="pop__chat-msg-avatar" :routeUrl="avatarLink"><img :src="avatar" /></span>                      <div class="pop__chat-msg-content">                        <p class="pop__chat-msg-author" v-if="type==\'group\'" v-html="name"></p>                        <div class="pop__chat-msg-msg" :class="messageType" @click="play" @contextmenu.stop.prevent @longTap.stop.prevent="showtapMenu($event,type,to,mid,from, content)">                            <span v-if="messageType!=\'pop__chat-msg-voice\'" v-html="htmlContent"></span>                            <span v-else-if="messageType==\'pop__chat-msg-voice\'">                                <template v-if="popim.mine.uid == from">                                    <span class="pop__voice-box pop__float-right pop__route180" :class="{\'pop__voice-playing\':state==\'running\'}"></span>                                    <span class="pop__voice-body pop__float-left"><span v-if="duration!=0">{{duration}}"</span></span>                                </template>                                <template v-else>                                    <span class="pop__voice-body pop__float-right pop__text-right">{{duration}}"</span>                                    <span class="pop__voice-box pop__float-left" :style="{\'animation-play-state\':state}" :class="{\'pop__voice-playing\':state==\'running\'}"></span>                                </template>                                <audio preload="auto" hidden="true" ref="voice" @play="setState" @ended="setState" @pause="setState" @abort="setState" @error="setState" @stalled="setState" @empted="setState" @durationchange="durationChange"><source :src="src" type="audio/mpeg"></audio>                            </span>                        </div>                      </div>                      <span v-if="popim.mine.uid==from" class="pop__chat-msg-avatar" :routeUrl="avatarLink"><img :src="avatar" /></span>                  </li>                  <li v-else-if="sub_type==\'notice\' && messageType" class="pop__chat-msg-notice"><span v-html="noticeContent()"></span></li>'}),page(popim.data.baseUri+"user/login",function(e){if(!popim.check(e))return;popim.syncSetting(),popim.show("login")}),page(popim.data.baseUri+"user/join",function(e){if(!popim.check(e))return;popim.syncSetting(),popim.show("join")}),page(popim.data.baseUri+"friend/remark/:uid",function(e){if(!popim.check(e))return;var t=e.params.uid;popim.setting("设置备注","备注",u.remarkname||u.nickname,"完成",function(){popim.ajax({url:popim.data.api.friendRemark,type:"post",data:{friend_uid:t,remark:h.content},success:function(e){e.code==0&&(popim.updateFriend(t,{name:popim.htmlEncode(h.content)}),history.back())}})})}),page(popim.data.baseUri+"group/remark/:gid",function(e){if(!popim.check(e))return;var t=e.params.gid;popim.setting("设置备注","备注",l.remark||l.groupname,"完成",function(){popim.ajax({url:popim.data.api.groupRemark,type:"post",data:{gid:t,remark:h.content},success:function(e){e.code==0&&(popim.data.chatting["group"+t]&&(popim.data.chatting["group"+t].name=popim.htmlEncode(h.content)),history.back())}})})}),page(popim.data.baseUri+"group/rename/:gid",function(e){if(!popim.check(e))return;var t=e.params.gid;popim.setting("设置群名称","名称",l.groupname,"完成",function(){popim.ajax({url:popim.data.api.groupUpdate,type:"post",data:{gid:t,groupname:h.content},success:function(e){e.code==0&&(popim.data.chatting["group"+t]&&(popim.data.chatting["group"+t].name=popim.htmlEncode(h.content)),history.back())}})})}),page.exit(popim.data.baseUri+"*/chat/*",function(e,t){s.reset(),popim.isback&&(popim.backToPath=popim.data.baseUri),s.tapMenuShow=!1,$(".pop__video-view .pop__close").trigger("click"),$(".pop__img-view").css("display")=="block"&&$(".pop__img-view").trigger("click"),t()});var E=new Vue({el:"#toast",data:{dataPosting:!1}});$(function(){$(".pop__panel").on("click","*[routeUrl]",function(e){var t=$(this).attr("routeUrl");if(!t)return;page(t)})}),$(function(){$(".pop__panel").on("click","*[replaceUrl]",function(e){var t=$(this).attr("replaceUrl");if(!t)return;page.replace(t)})}),$(window).on("popstate",function(){popim.isback=!0}),setInterval(function(){popim.autoUpdateTime()},6e4),$(function(){var e=0,t;$(".pop__chat-content").on("click",".pop__chat-msg-picture",function(){if(s.tapMenuShow)return;var n="",r=$(this).find("img").attr("src");$(".pop__chat-content li .pop__chat-msg-picture").each(function(t,i){n+='<div class="swiper-slide"><div class="swiper-zoom-container">'+$(this).html()+"</div></div>",$(this).find("img").attr("src")==r&&(e=t)}),$(".pop__img-view-container .swiper-wrapper").html(n),$(".pop__img-view").show(),t=new Swiper(".pop__img-view-container",{pagination:!1,paginationClickable:!0,zoom:!0,observer:!0,observeParents:!0,initialSlide:e})}),$(".pop__img-view").on("click",function(e){var n=$(this);t.destroy(!0,!0),$(".pop__img-view-container .swiper-wrapper").html(""),n.hide()})}),$(function(){var e=document.getElementById("pop__video");$(".pop__chat-content").on("click",".pop__chat-msg-video",function(){e.src=$(this).find("video").attr("src"),$(".pop__video-view").show(),e.paused?e.play():e.pause()}),e.addEventListener("ended",function(){e.currentTime=0},!1),$(e).on("click",function(e){e.stopPropagation()}),$(".pop__video-view").on("click",function(){$(".pop__video-view").hide(),e.currentTime=0,e.pause()}),e.addEventListener("x5videoenterfullscreen",function(){console.log("进入全屏")},!1),e.addEventListener("x5videoexitfullscreen",function(){$(".pop__video-view .pop__close").trigger("click")},!1)}),$(document).ready(function(e){popim.resizeWindow(),e(window).resize(popim.resizeWindow),popim.autoPlayPromptTone()}),page()})(),window.plus?plusReady():document.addEventListener("plusready",plusReady,!1);